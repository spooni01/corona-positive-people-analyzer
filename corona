#!/usr/bin/env bash

###############################################
#                                             #
# Name:     Corona - positive people analyzer #
# Author:   Adam Ližičiar, xlizic00           #
#                                             #
###############################################

#colors
RED="\033[0;31m"
NOCOLOR="\033[0m"

################################################
################# FUNCTIONS ####################
################################################

# Write help text
help()
{
    printf "${RED}"
    echo "--------------------------------------------------"
    echo "|                                                |"
    echo "|       CORONA - POSITIVE USER ANALYZER          |"
    echo "|                                                |"
    echo "--------------------------------------------------"
    printf "${NOCOLOR}"
    echo "FORMAT:"
    echo "corona [-h] [FILTERS] [COMMAND] [LOG [LOG2 [...]]"
    echo "--------------------------------------------------"
    echo "MAIN:"
    echo "-h -> vypise pomocnik"
    echo "--------------------------------------------------"
    echo "FILTERS:"
    echo "-a DATETIME -> vypis zaznamov iba pod danom datume"
    echo "-b DATETIME -> vypis zaznamov iba pred danym datumom"
    echo "-g GENDER -> filter podla pohlavia (M = muzi, Z = zeny)"
    echo "-s [WIDTH] -> vypis dat graficky"
    echo "--------------------------------------------------"
    echo "COMMAND:"
    echo "infected -> spocita pocet nakazenych"
    echo "merge -> spoji subory so zaznamami do jedneho"
    echo "gender -> pocet nakazenych pre jednotlive pohlavia"
    echo "age -> statistika nakazenych podla veku"
    echo "daily -> statistika nakazenych pre jednotlive dni"
    echo "monthly -> statistika nakazenych pre jednotlive mesiace"
    echo "yearly -> statistika nakazenych pre jednotlive roky"
    echo "countries -> stastika nakazenych pre krajiny nakazy"
    echo "districts -> stastika nakazenych pre okresy"   
    echo "regions -> stastika nakazenych pre kraje"
    printf "${RED}"
    echo "--------------------------------------------------"
    printf "${NOCOLOR}"
}

get_num_of_infected()
{
    declare -i num=0
    declare -i actual_line=0    # This counter is for skipping first line
        
    while IFS=, read -r id datum vek pohlavi kraj_nuts_kod okres_lau_kod nakaza_v_zahranici nakaza_zeme_csu_kod reportovano_khs
        do
            actual_line=$((actual_line + 1))

            if [ "$actual_line" != "1" ]
            then
                num=$((num + 1))
            fi
        done < osoby.csv

    echo "$num"   
}

get_num_of_gender()
{
    declare -i num=0
    declare -i actual_line=0    # This counter is for skipping first line
 
    while IFS=, read -r id datum vek pohlavi kraj_nuts_kod okres_lau_kod nakaza_v_zahranici nakaza_zeme_csu_kod reportovano_khs
        do
            actual_line=$((actual_line + 1))
            
            if [ "$actual_line" != "1" ]
            then
                if [ "$pohlavi" == "$1" ]
                then
                    num=$((num + 1))
                fi
            fi
        done < osoby.csv

    echo "$num"   
}

################################################
################### MAIN #######################
################################################

export POSIXLY_CORRECT=yes

# Help (in this case just print help text and end program)
if  [ "$1" = "-h" ] 
then
    help

# Write help
elif [ "$1" = "-a" ] && print "$2" | grep -qE "[0-9]{4}-[0-9]{2}-[0-9]{2}" && [ "$2" != "" ] 
then
    printf "datetime format ok"


# Write infected people
elif [ "$1" = "infected" ] || [ "$3" == "infected" ]
then 
    if [ "$1" != "" ] && [ "$2" != "" ] && [ "$3" = "infected" ] # Filter is set
    then
        get_num_of_gender "$2"   
    else
        get_num_of_infected
    fi    

# No command
else
    printf "Bol zadany nespravny tvar prikazu, pre napovedu napis ${RED}corona -h${NOCOLOR}\n"
fi

exit 0